name: Update AdGuard Home Rules

on:
  schedule:
    - cron: "0 2 * * *"  # 每天凌晨 2:00 UTC 更新规则
  push:
    branches:
      - main  # 监听 main 分支的推送事件

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
    # 步骤 1: 检出当前仓库的代码
    - name: Checkout repository
      uses: actions/checkout@v3

    # 步骤 2: 确保脚本具有执行权限，并运行脚本生成规则文件
    - name: Set execute permission for the script and run it
      run: |
        chmod +x generate_formatted_list.sh  # 给脚本加执行权限
        ./generate_formatted_list.sh        # 执行脚本
      continue-on-error: false  # 如果脚本失败，则停止后续步骤

    # 步骤 3: 检查是否有规则文件更新，如果更新则进行提交
    - name: Commit and push updated rules if file changed
      run: |
        # 检查是否有文件变更
        git diff --exit-code || (
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add adguard_home_rules.txt  # 添加更新的文件
          git commit -m "Update AdGuard Home rules"  # 提交更新
          git push  # 推送更改
        )
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 自动提供的 token 进行推送
